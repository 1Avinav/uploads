package com.hsbc.managementStudio.project.controller;

import com.hsbc.managementStudio.project.model.Project;
import com.hsbc.managementStudio.user.service.UserService;
import com.hsbc.managementStudio.project.service.ProjectService;
import com.hsbc.managementStudio.util.JwtUtil;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.mock.web.MockHttpServletRequest;

import static org.mockito.Mockito.*;
import static org.junit.jupiter.api.Assertions.*;

class ProjectControllerTest {

    @Mock
    private ProjectService projectService;

    @Mock
    private UserService userService;

    @Mock
    private JwtUtil jwtUtil;

    @InjectMocks
    private ProjectController projectController;

    private Project testProject;
    private MockHttpServletRequest request;

    @BeforeEach
    void setUp() {
        testProject = new Project();
        testProject.setProjectId(1L);
        testProject.setApiVersion("v1");
        testProject.setCreator("John Doe");
        testProject.setDataSensitivityLevel("High");
        testProject.setDescription("Test project description");
        testProject.setDocumentSource("Internal");
        testProject.setDocumentType("PDF");
        testProject.setProjectCode("PRJ001");
        testProject.setStatus("Active");
        testProject.setProjectName("Project Test");
        testProject.setCreatedDateTime(LocalDateTime.now());

        request = new MockHttpServletRequest();
    }

    @Test
    void testCreateProject_WithValidAuthHeader_ShouldReturnCreatedStatus() {
        // Mock behavior
        String authHeader = "Bearer some-jwt-token";
        request.addHeader("Authorization", authHeader);

        // Mocking JWT extraction and user service
        when(jwtUtil.extractSubject(authHeader)).thenReturn("adminUser");
        when(userService.isAdmin("adminUser")).thenReturn(true);
        when(projectService.createProject(testProject)).thenReturn(testProject);

        // Call the controller method
        ResponseEntity<Project> response = projectController.createProject(authHeader, testProject);

        // Validate response
        assertEquals(HttpStatus.CREATED, response.getStatusCode());
        assertEquals(testProject.getProjectName(), response.getBody().getProjectName());
    }

    @Test
    void testCreateProject_WithNonAdminUser_ShouldReturnForbiddenStatus() {
        // Mock behavior
        String authHeader = "Bearer some-jwt-token";
        request.addHeader("Authorization", authHeader);

        // Mocking JWT extraction and user service
        when(jwtUtil.extractSubject(authHeader)).thenReturn("regularUser");
        when(userService.isAdmin("regularUser")).thenReturn(false);

        // Call the controller method
        ResponseEntity<Project> response = projectController.createProject(authHeader, testProject);

        // Validate response
        assertEquals(HttpStatus.FORBIDDEN, response.getStatusCode());
    }
}
