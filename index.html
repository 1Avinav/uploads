package com.hsbc.managementstudio.service;

import com.hsbc.managementstudio.model.User;
import com.hsbc.managementstudio.repository.UserRepository;
import org.apache.tomcat.util.codec.binary.Base64;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.nio.charset.StandardCharsets;
import java.util.Map;

@Service
public class JwtUtil {

    @Autowired
    private UserRepository userRepository;

    // Decode JWT Token
    public Map<String, Object> decodeJwt(String token) {
        String[] parts = token.split("\\.");
        if (parts.length != 3) {
            throw new IllegalArgumentException("Invalid JWT token structure");
        }

        String payload = new String(Base64.decodeBase64(parts[1]), StandardCharsets.UTF_8);
        ObjectMapper objectMapper = new ObjectMapper();
        try {
            return objectMapper.readValue(payload, Map.class);
        } catch (Exception e) {
            throw new IllegalArgumentException("Error while decoding JWT token");
        }
    }

    // Get user 'sub' from the JWT token
    public String getSubFromJwt(String token) {
        Map<String, Object> claims = decodeJwt(token);
        return (String) claims.get("sub");
    }

    // Get user 'role' from the database based on 'sub' claim
    public String getRoleFromSub(String sub) {
        User user = userRepository.findByUserId(sub)
                .orElseThrow(() -> new IllegalArgumentException("User not found for sub: " + sub));
        return user.getRole();
    }
}
