package com.hsbc.managementstudio.util;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.tomcat.util.codec.binary.Base64;
import org.springframework.stereotype.Component;

import java.nio.charset.StandardCharsets;
import java.util.HashMap;
import java.util.Map;

@Component
public class JwtUtil {

    /**
     * Decodes a JWT token without signature verification.
     * Extracts the payload and returns it as a Map.
     *
     * @param token JWT token (including "Bearer " prefix)
     * @return Decoded payload as a Map
     */
    public Map<String, Object> decodeJwt(String token) {
        try {
            if (token == null || !token.startsWith("Bearer ")) {
                throw new IllegalArgumentException("Invalid Authorization header.");
            }

            String jwtToken = token.substring(7); // Remove "Bearer " prefix.

            // Split the token into parts (header, payload, signature)
            String[] tokenParts = jwtToken.split("\\.");
            if (tokenParts.length != 3) {
                throw new IllegalArgumentException("Invalid JWT structure.");
            }

            // Decode the payload (base64URL-decoded)
            String payload = new String(Base64.decodeBase64(tokenParts[1]), StandardCharsets.UTF_8);

            // Convert JSON payload to Map
            ObjectMapper objectMapper = new ObjectMapper();
            return objectMapper.readValue(payload, HashMap.class);
        } catch (Exception e) {
            throw new RuntimeException("Failed to decode JWT: " + e.getMessage(), e);
        }
    }

    /**
     * Extracts the `sub` claim (userId) from the decoded JWT.
     *
     * @param token JWT token (including "Bearer " prefix)
     * @return UserId (sub claim) from the JWT
     */
    public String getSubFromJwt(String token) {
        Map<String, Object> claims = decodeJwt(token);
        if (!claims.containsKey("sub")) {
            throw new RuntimeException("JWT does not contain 'sub' claim.");
        }
        return claims.get("sub").toString();
    }
}


@RestController
public class JwtController {

    @Autowired
    private JwtUtil jwtUtil;

    @Autowired
    private UserService userService;

    @GetMapping("/sso-login")
    public ResponseEntity<?> ssoLogin(@RequestHeader("Authorization") String authHeader) {
        try {
            // Decode the JWT to get the 'sub'
            String sub = jwtUtil.getSubFromJwt(authHeader);

            // Fetch user details from the database
            Optional<User> user = userService.getUserBySub(sub);
            if (user.isPresent()) {
                User userDetails = user.get();
                return ResponseEntity.ok(
                        Map.of(
                                "userId", userDetails.getUserId(),
                                "role", userDetails.getRole()
                        )
                );
            } else {
                return ResponseEntity.status(404).body("User not found.");
            }
        } catch (RuntimeException e) {
            return ResponseEntity.status(401).body(e.getMessage());
        }
    }
}
